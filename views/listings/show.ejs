<% layout("/layouts/boilerplate") %>

<div class="container my-5">
  <div class="row justify-content-center">

    <!-- ✅ Listing Card -->
    <div class="col-md-10 col-lg-8">
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden">

        <!-- Image -->
        <div class="listing-img-wrap position-relative">
          <img 
            src="<%= post.image?.url || post.image || 'https://images.unsplash.com/photo-1505691938895-1758d7feb511?w=1200' %>" 
            class="listing-img"
            alt="listing_image"
          >

          <span class="price-badge">
            ₹ <%= Number(post.price).toLocaleString("en-IN") %> / night
          </span>
        </div>

        <!-- ✅ Owner -->
        <div class="p-3 bg-light border-bottom">
          <h5 class="m-0 fw-semibold">
            Owned By: 
            <%= post.owner?.[0]?.username || post.owner?.[0]?.email || "Unknown" %>
          </h5>
        </div>

        <!-- Body -->
        <div class="card-body p-4 p-md-5">
          <h2 class="fw-bold mb-2"><%= post.title %></h2>

          <p class="text-muted mb-4">
            <i class="fa-solid fa-location-dot me-1 text-danger"></i>
            <%= post.location %>, <%= post.country %>
          </p>

          <h5 class="fw-semibold mb-2">Description</h5>
          <p class="text-muted mb-4"><%= post.description %></p>

          <!-- Price & Location boxes -->
          <div class="row g-3 mb-4">
            
            <!-- Price -->
            <div class="col-md-6">
              <div class="p-3 rounded-3 bg-light border h-100 d-flex flex-column justify-content-center">
                <p class="mb-1 text-muted">Price</p>
                <h5 class="mb-0 fw-bold">
                  ₹ <%= Number(post.price).toLocaleString("en-IN") %>
                </h5>
              </div>
            </div>

            <!-- Location -->
            <div class="col-md-6">
              <div class="p-3 rounded-3 bg-light border h-100 d-flex flex-column justify-content-center">
                <p class="mb-1 text-muted">Location</p>
                <h6 class="mb-0 fw-semibold text-truncate">
                  <i class="fa-solid fa-location-dot me-1 text-danger"></i>
                  <%= post.location %>, <%= post.country %>
                </h6>
              </div>
            </div>
          </div>

          <!-- ✅ Edit/Delete ONLY owner can see -->
          <div class="d-flex gap-2 mb-3">
            <a href="/listings/<%= post._id %>/edit" class="btn btn-danger w-100 fw-semibold">
              Edit
            </a>

            <form method="POST" action="/listings/<%= post._id %>?_method=DELETE" class="w-100">
              <button class="btn btn-outline-dark w-100 fw-semibold" type="submit">
                Delete
              </button>
            </form>
          </div>

          <!-- Back -->
          <div class="mt-4 text-center">
            <a href="/listings" class="text-decoration-none">← Back to Listings</a>
          </div>
        </div>

      </div>
    </div>

    <!-- ✅ Review Form -->
    <div class="col-md-10 col-lg-8 mt-5">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-4">

          <h4 class="fw-bold mb-3">Leave a Review</h4>

          <form class="needs-validation" novalidate
                action="/listings/<%= post._id %>/reviews"
                method="POST">

            <!-- ✅ Rating Stars -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Rating</label>

              <div class="star-rating">
                <input type="radio" id="star5" name="review[rating]" value="5" required>
                <label for="star5" title="5 stars">★</label>

                <input type="radio" id="star4" name="review[rating]" value="4">
                <label for="star4" title="4 stars">★</label>

                <input type="radio" id="star3" name="review[rating]" value="3">
                <label for="star3" title="3 stars">★</label>

                <input type="radio" id="star2" name="review[rating]" value="2">
                <label for="star2" title="2 stars">★</label>

                <input type="radio" id="star1" name="review[rating]" value="1">
                <label for="star1" title="1 star">★</label>
              </div>

              <div class="invalid-feedback">Please select a rating.</div>
            </div>

            <!-- Comment -->
            <div class="mb-3">
              <label for="comment" class="form-label fw-semibold">Comment</label>

              <textarea
                name="review[comment]"
                id="comment"
                class="form-control"
                rows="3"
                placeholder="Write your review here..."
                required
              ></textarea>

              <div class="invalid-feedback">Please write a comment.</div>
            </div>

            <button class="btn btn-danger fw-semibold" type="submit">
              Submit Review
            </button>

          </form>

        </div>
      </div>
    </div>

    <!-- ✅ All Reviews Section -->
    <div class="col-md-10 col-lg-8 mt-5">
      <h4 class="fw-bold mb-4">All Reviews</h4>

      <% if (post.reviews.length === 0) { %>
        <div class="alert alert-secondary rounded-4 shadow-sm" role="alert">
          No reviews yet. Be the first one to review!
        </div>
      <% } else { %>

        <div class="row g-3">
          <% for (let review of post.reviews) { %>
           
            <div class="col-12">
              <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body">

                  <div class="d-flex justify-content-between align-items-center mb-2">

                    <!-- ✅ Review Author -->
                    <h5 class="mb-0"><%= review.author?.username || review.author?.email || "Anonymous" %></h5>

                    <!-- ✅ Stars Rating (No badge color) -->
                    <% const rating = Number(review.rating); %>
                    <div class="review-stars">
                      <% for(let i=1; i<=5; i++){ %>
                        <span class="<%= i<=rating ? 'star-filled' : 'star-empty' %>">★</span>
                      <% } %>
                    </div>

                    <!-- ✅ Delete Review -->
                    <form
                      method="POST"
                      action="/listings/<%= post._id %>/reviews/<%= review._id %>?_method=DELETE"
                      class="d-inline"
                    >
                      <button type="submit" class="btn btn-outline-danger btn-sm fw-semibold">
                        <i class="fa-solid fa-trash me-1"></i> Delete
                      </button>
                    </form>

                  </div>

                  <!-- ✅ Comment -->
                  <p class="mb-0 text-muted fw-semibold">
                    <%= review.comment %>
                  </p>

                </div>
              </div>
            </div>

          <% } %>
        </div>

      <% } %>
    </div>

  </div>
</div>
